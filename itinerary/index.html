<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Travel Itinerary</title>

    <style>html,body{background:#121212;color:#eee;}</style>
    <!-- this sets all the styles -->
    <link rel="stylesheet" href="../styles/style.css" />

    <!-- this link allows icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    
  </head>

  <body>
    <nav>
      <div class="nav-title">Itinerary</div>
      <button class="hamburger" aria-label="Toggle menu" onclick="toggleMenu()">â˜°</button>
      <div class="nav-links" id="navLinks">
        <a href="../index.html"><i class="fa-solid fa-user fa-icon"></i>Profile Hub</a>
        <a href="/gallery/index.html"><i class="fa-solid fa-photo-film fa-icon"></i>Galleries</a>
        <a href="/itinerary/index.html" class="active"><i class="fa-solid fa-plane fa-icon"></i>Itinerary</a>
      </div>
    </nav>

    <h1>My Travel Itinerary</h1>
    <div class="itinerary-container">
      <div id="adminSection" class="sticky-form" style="display:none;">
        <form id="itineraryForm">
          <label for="destination">Destination</label>
          <input type="text" id="destination" placeholder="-" required />
          <label for="startDate">Start</label>
          <input type="date" id="startDate" required />
          <label for="endDate">End</label>
          <input type="date" id="endDate" required />
          <label for="details">Details</label>
          <textarea id="details" placeholder="-" rows="4" required></textarea>
          <button type="submit">Add Itinerary</button>
        </form>
      </div>
      <div class="entries-list" id="itineraryList"></div>
      <button id="adminLoginBtn" style="position:fixed;bottom:24px;right:24px;z-index:9999;opacity:0.5;">Admin Login</button>
    </div>

    <script>
      const form = document.getElementById('itineraryForm');
      const list = document.getElementById('itineraryList');
      const adminSection = document.getElementById('adminSection');
      let editIndex = null;
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      let isAdmin = false;

      // Admin mode logic
      function checkAdmin() {
        isAdmin = localStorage.getItem('itineraryAdmin') === 'true';
        adminSection.style.display = isAdmin ? 'block' : 'none';
        adminLoginBtn.textContent = isAdmin ? 'Logout Admin' : 'Admin Login';
        loadItineraries();
      }
      adminLoginBtn.addEventListener('click', function() {
        if (isAdmin) {
          localStorage.removeItem('itineraryAdmin');
          checkAdmin();
        } else {
          const pw = prompt('Enter admin password:');
          if (pw === 'letmein') {
            localStorage.setItem('itineraryAdmin', 'true');
            checkAdmin();
          } else {
            alert('Incorrect password.');
          }
        }
      });

      // Prevent end date before start date
      startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
          endDateInput.value = this.value;
        }
      });

      // Sort helper function: oldest to newest by startDate
      function sortByDateAsc(array) {
        return array.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
      }

      function loadItineraries() {
        let items = JSON.parse(localStorage.getItem('itinerary') || '[]');
        items = sortByDateAsc(items); // Sort before displaying
        list.innerHTML = '';
        items.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'entry';
          // Calendar links
          const start = item.startDate.replace(/-/g, '');
          const end = item.endDate.replace(/-/g, '');
          const title = encodeURIComponent(item.destination);
          const details = encodeURIComponent(item.details);
          const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}`;
          const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&body=${details}&startdt=${item.startDate}&enddt=${item.endDate}`;
          div.innerHTML = `
            <h3>${item.destination} (${item.startDate} - ${item.endDate})</h3>
            <p>${item.details}</p>
            <a href="${googleUrl}" target="_blank" rel="noopener" class="calendar-btn">Add to Google Calendar</a> - 
            <a href="${outlookUrl}" target="_blank" rel="noopener" class="calendar-btn">Add to Outlook</a>
            ${isAdmin ? `<button onclick="editItinerary(${index})">Edit</button> <button onclick="deleteItinerary(${index})">Delete</button>` : ''}
          `;
          list.appendChild(div);
        });
      }

      function deleteItinerary(index) {
        const items = JSON.parse(localStorage.getItem('itinerary') || '[]');
        items.splice(index, 1);
        localStorage.setItem('itinerary', JSON.stringify(items));
        loadItineraries();
        if (editIndex === index) {
          form.reset();
          editIndex = null;
        }
      }

      function editItinerary(index) {
        const items = JSON.parse(localStorage.getItem('itinerary') || '[]');
        const item = items[index];
        document.getElementById('destination').value = item.destination;
        document.getElementById('startDate').value = item.startDate;
        document.getElementById('endDate').value = item.endDate;
        document.getElementById('details').value = item.details;
        editIndex = index;
        form.querySelector('button[type="submit"]').textContent = 'Update Itinerary';
      }

      form.addEventListener('submit', e => {
        e.preventDefault();
        if (endDateInput.value < startDateInput.value) {
          alert('End date cannot be before start date.');
          return;
        }
        const newItem = {
          destination: document.getElementById('destination').value,
          startDate: startDateInput.value,
          endDate: endDateInput.value,
          details: document.getElementById('details').value
        };
        let items = JSON.parse(localStorage.getItem('itinerary') || '[]');
        if (editIndex !== null) {
          items[editIndex] = newItem;
          editIndex = null;
          form.querySelector('button[type="submit"]').textContent = 'Add Itinerary';
        } else {
          items.push(newItem);
        }
        items = sortByDateAsc(items); // Sort before saving
        localStorage.setItem('itinerary', JSON.stringify(items));
        form.reset();
        loadItineraries();
      });

      window.onload = function() {
        checkAdmin();
      };
    </script>

    <script>
      function toggleMenu() {
        document.getElementById('navLinks').classList.toggle('open');
      }
    </script>
  </body>
</html>
