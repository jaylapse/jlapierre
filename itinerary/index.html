<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <div id="nav-placeholder"></div>

    <title>Travel Itinerary</title>

    <style>
      html, body {
        background: #121212;
        color: #eee;
      }
      nav {
        background-color: #181a1b;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-width: 100%;
        margin: 0 auto;
      }
      .nav-title {
        font-weight: bold;
        font-size: 1.5rem;
        color: #f1f1f1;
      }
      .nav-links {
        display: flex;
        gap: 2rem;
      }
      .nav-links a {
        color: #b3e5fc;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s, color 0.2s, transform 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .nav-links a:hover,
      .nav-links a.active {
        background-color: #23272a;
        color: #ff3860;
        transform: scale(1.05);
      }
      .hamburger {
        display: none;
        background: none;
        border: none;
        font-size: 1.8rem;
        color: #f1f1f1;
        cursor: pointer;
      }
      @media (max-width: 768px) {
        .nav-links {
          position: fixed;
          top: 56px;
          right: 0;
          background-color: #181a1b;
          height: calc(100vh - 56px);
          width: 200px;
          flex-direction: column;
          padding: 1rem;
          gap: 1rem;
          transform: translateX(100%);
          transition: transform 0.3s ease;
          box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        .nav-links.open {
          transform: translateX(0);
        }
        .hamburger {
          display: block;
        }
      }
    </style>
    <link rel="stylesheet" href="../styles/style.css" />

    <!-- this link allows icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2tu6p+U6GkG6aQpQbQ4Q4Q4Q4Q4=" crossorigin=""/>
    <style>
      #map { height: 350px; width: 100%; margin-bottom: 1.5rem; border-radius: 10px; }
      .timeline-container { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
      .timeline-btn { background: #23272a; color: #eee; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.2rem; }
      .timeline-dot { width: 18px; height: 18px; border-radius: 50%; background: #4ea8de; margin: 0 8px; display: inline-block; opacity: 0.5; border: 2px solid #23272a; transition: opacity 0.2s, border 0.2s; }
      .timeline-dot.active { opacity: 1; border: 2px solid #ff3860; }
    </style>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j6kG6aQpQbQ4Q4Q4Q4=" crossorigin=""></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      // TODO: Replace with your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCrXvaiwHdc5whQHuhk6SR7EutV_MY7HWE",
  authDomain: "jlapierre-9ed45.firebaseapp.com",
  projectId: "jlapierre-9ed45",
  storageBucket: "jlapierre-9ed45.firebasestorage.app",
  messagingSenderId: "747343028064",
  appId: "1:747343028064:web:2ef67506c81c09103ac805",
  measurementId: "G-EFMF6L65H5"
};  
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>
  </head>

  <body>
    <div id="nav-placeholder"></div>

    <h1>My Travel Itinerary</h1>
    <div id="countdown" style="text-align:center;font-size:1.2rem;margin:1rem 0;"></div>
    <div class="itinerary-container" style="position:relative;">
      <div id="adminSection" class="sticky-form" style="display:none;">
        <form id="itineraryForm">
          <label for="destination">Destination</label>
          <input type="text" id="destination" placeholder="-" required />
          <label for="startDate">Start</label>
          <input type="date" id="startDate" required />
          <label for="endDate">End</label>
          <input type="date" id="endDate" required />
          <label for="details">Details</label>
          <textarea id="details" placeholder="-" rows="4" required></textarea>
          <button type="submit">Add Itinerary</button>
        </form>
      </div>
      <div class="fold-controls">
        <button id="foldAllBtn" type="button" title="Fold All"><i class="fa-solid fa-chevron-up"></i></button>
        <button id="unfoldAllBtn" type="button" title="Unfold All"><i class="fa-solid fa-chevron-down"></i></button>
      </div>
      <div class="entries-list" id="itineraryList"></div>
      <button id="adminLoginBtn" style="position:fixed;bottom:24px;right:24px;z-index:9999;opacity:0.5;">Admin Login</button>
    </div>
    <style>
      .fold-controls {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.5rem;
        z-index: 10;
      }
      .fold-controls button {
        background: #23272a;
        color: #eee;
        border: none;
        border-radius: 4px;
        width: 2.2rem;
        height: 2.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.10);
        cursor: pointer;
        transition: background 0.2s, color 0.2s, transform 0.1s;
      }
      .fold-controls button:hover {
        background: #4ea8de;
        color: #fff;
        transform: scale(1.08);
      }
      @media (max-width: 700px) {
        .fold-controls {
          top: 0.2rem;
          right: 0.2rem;
        }
      }
      .toggle-btn {
        width: 1.3rem;
        height: 1.3rem;
        min-width: 1.3rem;
        min-height: 1.3rem;
        font-size: 0.95rem !important;
        padding: 0.1rem 0.2rem;
        border-radius: 4px;
        border: none;
        background: #23272a;
        color: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, transform 0.1s;
      }
      .toggle-btn:hover {
        background: #4ea8de;
        color: #fff;
        transform: scale(1.08);
      }
    </style>

    <script>
      const form = document.getElementById('itineraryForm');
      const list = document.getElementById('itineraryList');
      const adminSection = document.getElementById('adminSection');
      let editIndex = null;
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      let isAdmin = false;
      let editId = null;

      // Admin mode logic
      function checkAdmin() {
        isAdmin = localStorage.getItem('itineraryAdmin') === 'true';
        adminSection.style.display = isAdmin ? 'block' : 'none';
        adminLoginBtn.textContent = isAdmin ? 'Logout Admin' : 'Admin Login';
        loadItineraries();
      }
      adminLoginBtn.addEventListener('click', function() {
        if (isAdmin) {
          localStorage.removeItem('itineraryAdmin');
          checkAdmin();
        } else {
          const pw = prompt('Enter admin password:');
          if (pw === 'letmein') {
            localStorage.setItem('itineraryAdmin', 'true');
            checkAdmin();
          } else {
            alert('Incorrect password.');
          }
        }
      });

      // Prevent end date before start date
      startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
          endDateInput.value = this.value;
        }
      });

      // Sort helper function: oldest to newest by startDate
      function sortByDateAsc(array) {
        return array.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
      }

      // Replace all localStorage itinerary logic with Firestore
      async function fetchItineraries() {
        const snapshot = await db.collection('itineraries').orderBy('startDate').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }
      async function addItinerary(item) {
        await db.collection('itineraries').add(item);
      }
      async function updateItinerary(id, item) {
        await db.collection('itineraries').doc(id).set(item);
      }
      async function deleteItineraryFromDb(id) {
        await db.collection('itineraries').doc(id).delete();
      }
      // Patch loadItineraries to use Firestore
      async function loadItineraries() {
        const items = await fetchItineraries();
        list.innerHTML = '';
        const today = new Date().toISOString().slice(0, 10);
        items.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'entry';
          div.style.position = 'relative';
          // Highlight past entries
          const isPast = item.endDate < today;
          if (isPast) {
            div.style.background = '#4e2323'; // red shade for past
          }
          // Collapsible logic
          const collapsed = isPast ? 'collapsed' : '';
          div.innerHTML = `
            <div class="entry-toggle-btn" style="position:absolute;top:0.7rem;right:0.7rem;z-index:2;">
              <button class="toggle-btn" aria-label="Toggle details" style="width:1.3rem;height:1.3rem;font-size:0.95rem;padding:0.1rem 0.2rem;border-radius:4px;">
                <i class="fa-solid ${collapsed ? 'fa-chevron-down' : 'fa-chevron-up'}"></i>
              </button>
            </div>
            <div class="entry-header" style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
              <h3 style="margin:0;flex:1;">${item.destination} (${item.startDate} - ${item.endDate})
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.destination)}" target="_blank" title="View on Google Maps" style="margin-left:8px;color:#4ea8de;"><i class="fa-solid fa-map-location-dot"></i></a>
              </h3>
            </div>
            <div class="entry-details" style="display:${collapsed ? 'none' : 'block'};margin-top:0.5rem;">
              <p>${item.details}</p>
              <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(item.destination)}&dates=${item.startDate.replace(/-/g, '')}/${item.endDate.replace(/-/g, '')}&details=${encodeURIComponent(item.details)}" target="_blank" rel="noopener" class="calendar-btn" title="Add to Google Calendar" style="margin-right:0.7rem;font-size:1.2rem;color:#4285F4;"><i class="fa-brands fa-google"></i></a>
              <a href="https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(item.destination)}&body=${encodeURIComponent(item.details)}&startdt=${item.startDate}&enddt=${item.endDate}" target="_blank" rel="noopener" class="calendar-btn" title="Add to Outlook" style="font-size:1.2rem;color:#4ea8de;"><i class="fa-solid fa-envelope"></i></a>
              ${isAdmin ? `<button onclick="editItinerary('${item.id}')">Edit</button> <button onclick="deleteItinerary('${item.id}')">Delete</button>` : ''}
            </div>
          `;
          // Toggle logic
          div.querySelector('.toggle-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            const details = div.querySelector('.entry-details');
            const icon = div.querySelector('.toggle-btn i');
            if (details.style.display === 'none') {
              details.style.display = 'block';
              icon.classList.remove('fa-chevron-down');
              icon.classList.add('fa-chevron-up');
            } else {
              details.style.display = 'none';
              icon.classList.remove('fa-chevron-up');
              icon.classList.add('fa-chevron-down');
            }
          });
          list.appendChild(div);
        });
        updateCountdown(items);
      }

      form.addEventListener('submit', async e => {
        e.preventDefault();
        if (endDateInput.value < startDateInput.value) {
          alert('End date cannot be before start date.');
          return;
        }
        const newItem = {
          destination: document.getElementById('destination').value,
          startDate: startDateInput.value,
          endDate: endDateInput.value,
          details: document.getElementById('details').value
        };
        if (editId) {
          await updateItinerary(editId, newItem);
          editId = null;
          form.querySelector('button[type="submit"]').textContent = 'Add Itinerary';
        } else {
          await addItinerary(newItem);
        }
        form.reset();
        loadItineraries();
      });

      window.editItinerary = async function(id) {
        const items = await fetchItineraries();
        const item = items.find(i => i.id === id);
        document.getElementById('destination').value = item.destination;
        document.getElementById('startDate').value = item.startDate;
        document.getElementById('endDate').value = item.endDate;
        document.getElementById('details').value = item.details;
        editId = id;
        form.querySelector('button[type="submit"]').textContent = 'Update Itinerary';
      }

      window.deleteItinerary = async function(id) {
        await deleteItineraryFromDb(id);
        loadItineraries();
        if (editId === id) {
          form.reset();
          editId = null;
        }
      }

      function updateCountdown(items) {
        const countdownDiv = document.getElementById('countdown');
        const today = new Date().toISOString().slice(0, 10);
        const upcoming = items.filter(item => item.startDate > today);
        if (!upcoming.length) {
          countdownDiv.textContent = '';
          return;
        }
        const next = upcoming[0];
        const diff = Math.ceil((new Date(next.startDate) - new Date()) / (1000*60*60*24));
        countdownDiv.textContent = `Next trip: ${next.destination} in ${diff} day${diff !== 1 ? 's' : ''} (${next.startDate})`;
      }

      window.onload = function() {
        checkAdmin();
      };

      // Fold/Unfold All logic
      document.getElementById('foldAllBtn').onclick = function() {
        document.querySelectorAll('.entry .entry-details').forEach(d => { d.style.display = 'none'; });
        document.querySelectorAll('.entry .toggle-btn i').forEach(icon => {
          icon.classList.remove('fa-chevron-up');
          icon.classList.add('fa-chevron-down');
        });
      };
      document.getElementById('unfoldAllBtn').onclick = function() {
        document.querySelectorAll('.entry .entry-details').forEach(d => { d.style.display = 'block'; });
        document.querySelectorAll('.entry .toggle-btn i').forEach(icon => {
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-up');
        });
      };

    </script>

    <script>
      function toggleMenu() {
        document.getElementById('navLinks').classList.toggle('open');
      }
    </script>

  <div id="footer-placeholder"></div>

   <script>
    // Load nav and footer templates dynamically
    function loadTemplate(id, url) {
      fetch(url)
        .then(res => res.text())
        .then(html => { document.getElementById(id).innerHTML = html; });
    }
    loadTemplate('nav-placeholder', '/nav-template.html');
    loadTemplate('footer-placeholder', '/footer-template.html');
  </script>
  </body>
</html>
